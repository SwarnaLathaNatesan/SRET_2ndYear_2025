<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Segment Tree — Step-by-step Visualizer</title>
<style>
  :root{
    --bg:#071028;
    --panel:#071427;
    --accent:#22d3ee;
    --node:#3b82f6;
    --visited:#f59e0b;
    --contrib:#10b981;
    --text:#e6eef8;
  }
  body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(140deg,var(--bg) 0%, #031025 100%);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:var(--text);
    padding:24px;
    box-sizing:border-box;
  }
  .wrap{ max-width:1200px; margin:0 auto; }

  header{ text-align:center; margin-bottom:10px; }
  h1{ margin:6px 0; font-size:1.5rem; color:#eaf6ff; }
  p.lead{ color:#cfeffd; opacity:.85; margin:0; }

  .controls {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin:12px 0 6px;
    align-items:center;
  }
  input[type="text"], input[type="number"]{
    padding:8px 10px;
    border-radius:8px;
    border:0;
    outline:none;
    min-width:140px;
    box-shadow:0 6px 18px rgba(2,6,23,0.6);
    background:#071226;
    color:var(--text);
  }
  button.btn{
    background:linear-gradient(90deg,#2563eb,#22d3ee);
    border:none;
    color:#012;
    padding:8px 12px;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
  }
  button.ghost{
    background:transparent;
    color:var(--text);
    border:1px solid rgba(255,255,255,0.06);
  }

  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:12px;
    box-shadow: 0 10px 40px rgba(2,6,23,0.6);
    margin-bottom:12px;
  }

  .array-display{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:center;
    padding:10px 6px;
  }
  .cell{
    min-width:60px;
    height:60px;
    background:linear-gradient(135deg,#1e3a8a,#2563eb);
    color:white;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-weight:700;
    box-shadow:0 8px 24px rgba(2,6,23,0.6);
  }
  .cell small{ opacity:.9; font-weight:700; font-size:12px; }

  /* Tree area */
  .tree-area{ position:relative; padding:12px; overflow:auto; border-radius:10px; }
  #svg-lines{ position:absolute; inset:0; pointer-events:none; z-index:0; }
  .tree{ display:flex; flex-direction:column; align-items:center; gap:18px; padding:18px 8px 40px; z-index:1; }
  .level{ display:flex; gap:14px; align-items:flex-start; justify-content:center; min-width:520px; }
  .node{
    position:relative;
    min-width:80px;
    padding:8px 10px;
    background:linear-gradient(135deg,#3b82f6,#22d3ee);
    color:#001018;
    border-radius:10px;
    text-align:center;
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    cursor:pointer;
    transition: transform .12s ease;
    z-index:2;
  }
  .node:hover{ transform:translateY(-6px); }
  .node .range{ font-size:13px; font-weight:800; color:#04233f; }
  .node .value{ font-size:18px; font-weight:900; color:#001018; margin-top:6px; }

  .visited{ animation: flashVisited 420ms ease both; background:linear-gradient(135deg,#f59e0b,#fbbf24) !important; color:#061016; box-shadow:0 12px 36px rgba(245,158,11,0.12); }
  .contrib{ animation: flashContrib 420ms ease both; background:linear-gradient(135deg,#10b981,#059669) !important; color:#01120f; box-shadow:0 12px 36px rgba(16,185,129,0.12); }
  @keyframes flashVisited{ 0%{ transform: scale(1) } 50%{ transform: scale(1.06) } 100%{ transform: scale(1) } }
  @keyframes flashContrib{ 0%{ transform: scale(1) } 50%{ transform: scale(1.1) } 100%{ transform: scale(1) } }

  .controls-steps{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .small{ font-size:13px; color:#cfeffd; opacity:.92; }

  .steps{ margin-top:10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:8px; color:#dff6ff; font-weight:600; }
  .steps small{ display:block; color:#bfeffd; font-weight:500; margin-top:6px; }

  .legend{ display:flex; gap:12px; align-items:center; justify-content:center; margin-top:8px; }
  .legend .dot{ width:14px; height:14px; border-radius:4px; display:inline-block; vertical-align:middle; }

  footer{ text-align:center; opacity:.7; margin-top:10px; font-size:13px; }

  @media (max-width:720px){
    .level{ gap:8px; min-width:unset; }
    .node{ min-width:62px; padding:6px; }
    .cell{ min-width:50px; height:50px; font-size:13px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Segment Tree — Step-by-step Visualizer</h1>
    <p class="lead">Build any array → generate tree → step through a range query (Prev / Next / Play)</p>
  </header>

  <div class="panel">
    <div class="controls">
      <input id="array-input" type="text" placeholder="Enter array like: 1,3,5,7" value="1,3,5,7,9,11" />
      <button class="btn" id="build-btn">Build Tree</button>

      <label style="display:flex; gap:6px; align-items:center;">
        <input id="q-l" type="number" placeholder="l" style="width:78px" />
        <input id="q-r" type="number" placeholder="r" style="width:78px" />
      </label>
      <button class="btn ghost" id="run-query">Run Query (record)</button>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <button class="btn ghost" id="prev-step" disabled>&larr; Prev</button>
        <button class="btn ghost" id="next-step" disabled>Next &rarr;</button>
        <button class="btn ghost" id="play-pause" disabled>Play</button>
        <label class="small" style="display:flex; gap:6px; align-items:center;">
          Speed
          <input id="speed" type="range" min="100" max="1200" value="500" />
        </label>
      </div>
    </div>

    <div class="array-display panel" id="array-display"></div>
  </div>

  <div class="panel tree-area" id="tree-panel">
    <svg id="svg-lines" xmlns="http://www.w3.org/2000/svg"></svg>
    <div class="tree" id="tree-root"></div>

    <div class="legend">
      <div style="display:flex; gap:8px; align-items:center;"><span class="dot" style="background:var(--visited)"></span><span>Visited</span></div>
      <div style="display:flex; gap:8px; align-items:center;"><span class="dot" style="background:var(--contrib)"></span><span>Contributes</span></div>
    </div>

    <div class="steps" id="calculation-steps">
      <div><strong>Steps / result:</strong></div>
      <small>Build tree and run a query to record steps.</small>
    </div>
  </div>

  <footer>Interactive stepper — single-run or manual stepping</footer>
</div>

<script>
(() => {
  // DOM refs
  const arrayInput = document.getElementById('array-input');
  const buildBtn = document.getElementById('build-btn');
  const arrayDisplay = document.getElementById('array-display');
  const treeRoot = document.getElementById('tree-root');
  const svg = document.getElementById('svg-lines');
  const runQueryBtn = document.getElementById('run-query');
  const ql = document.getElementById('q-l');
  const qr = document.getElementById('q-r');
  const prevBtn = document.getElementById('prev-step');
  const nextBtn = document.getElementById('next-step');
  const playBtn = document.getElementById('play-pause');
  const speedRange = document.getElementById('speed');
  const stepsEl = document.getElementById('calculation-steps');

  let currentArray = [];
  let tree = null;
  let eventList = [];           // recorded events for the query
  let currentStep = -1;
  let visitedCounts = {};       // counts to support undo
  let contribCounts = {};
  let runningTotal = 0;
  let playInterval = null;

  // parse input
  function parseArrayInput(text){
    return text.split(',')
      .map(s => s.trim())
      .filter(s => s !== '')
      .map(s => Number(s))
      .filter(n => !Number.isNaN(n));
  }

  function renderArray(arr){
    arrayDisplay.innerHTML = '';
    arr.forEach((v,i) => {
      const d = document.createElement('div');
      d.className = 'cell';
      d.innerHTML = `<small>Idx ${i}</small><div style="margin-top:6px; font-weight:900;">${v}</div>`;
      arrayDisplay.appendChild(d);
    });
  }

  function buildSegmentTree(arr){
    const n = arr.length;
    const size = Math.pow(2, Math.ceil(Math.log2(Math.max(1,n))));
    const treeArr = new Array(2 * size);
    for (let i=0;i<2*size;i++) treeArr[i] = {value:0, start:-1, end:-1};

    // leaves
    for (let i=0;i<n;i++){
      treeArr[size + i] = { value: arr[i], start: i, end: i };
    }
    for (let i=n;i<size;i++){
      treeArr[size + i] = { value: 0, start: i, end: i };
    }
    // internal nodes
    for (let i=size-1;i>0;i--){
      const L = treeArr[2*i];
      const R = treeArr[2*i+1];
      treeArr[i] = {
        value: (L.value || 0) + (R.value || 0),
        start: (L.start !== -1 ? L.start : R.start),
        end: (R.end !== -1 ? R.end : L.end)
      };
    }
    treeArr.size = size;
    treeArr.realLength = n; // store original array length
    return treeArr;
  }

  function renderTreeDOM(treeArr){
    treeRoot.innerHTML = '';
    svg.innerHTML = '';
    visitedCounts = {};
    contribCounts = {};
    runningTotal = 0;
    eventList = [];
    currentStep = -1;

    const size = treeArr.size;
    const levels = Math.ceil(Math.log2(size)) + 1;
    const levelContainers = [];

    for (let lv=0; lv<levels; lv++){
      const lvDiv = document.createElement('div');
      lvDiv.className = 'level';
      treeRoot.appendChild(lvDiv);
      levelContainers.push(lvDiv);
    }

    for (let i=1;i<treeArr.length;i++){
      if (treeArr[i] && treeArr[i].start !== -1){
        const nodeEl = document.createElement('div');
        nodeEl.className = 'node';
        nodeEl.id = 'node-' + i;
        nodeEl.dataset.index = i;
        nodeEl.innerHTML = `<div class="range">[${treeArr[i].start}, ${treeArr[i].end}]</div><div class="value">${treeArr[i].value}</div>`;
        const level = Math.floor(Math.log2(i));
        levelContainers[level].appendChild(nodeEl);
      }
    }

    // redraw connectors after layout
    requestAnimationFrame(drawAllConnectors);

    // reset UI controls
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    playBtn.disabled = true;
    stepsEl.innerHTML = `<div><strong>Steps / result:</strong></div><small>Now run a query to record steps.</small>`;
  }

  function drawAllConnectors(){
    svg.innerHTML = '';
    const nodes = document.querySelectorAll('.node');
    const coords = {};
    const panelRect = document.getElementById('tree-panel').getBoundingClientRect();

    nodes.forEach(n => {
      const r = n.getBoundingClientRect();
      const cx = r.left + r.width/2 - panelRect.left;
      const cy = r.top + r.height/2 - panelRect.top;
      coords[n.id] = {cx, cy, el: n};
    });

    Object.keys(coords).forEach(id => {
      const idx = Number(id.replace('node-',''));
      const parentIdx = Math.floor(idx/2);
      if (parentIdx >= 1){
        const parentId = 'node-' + parentIdx;
        if (coords[parentId]){
          const p = coords[parentId];
          const c = coords[id];
          const path = makeConnectorPath(p.cx, p.cy + 18, c.cx, c.cy - 18);
          svg.appendChild(path);
        }
      }
    });
  }

  function makeConnectorPath(x1, y1, x2, y2){
    const ns = "http://www.w3.org/2000/svg";
    const path = document.createElementNS(ns, 'path');
    const dx = (x2 - x1);
    const dy = (y2 - y1);
    const mx = x1 + dx * 0.5;
    const my = y1 + dy * 0.45;
    const d = `M ${x1} ${y1} Q ${mx} ${my} ${x2} ${y2}`;
    path.setAttribute('d', d);
    path.setAttribute('stroke', 'rgba(150,200,255,0.95)');
    path.setAttribute('fill','none');
    path.setAttribute('stroke-width','3');
    path.setAttribute('stroke-linecap','round');
    return path;
  }

  // Reset highlights & counters
  function clearAllHighlights(){
    document.querySelectorAll('.node').forEach(n=>{
      n.classList.remove('visited','contrib');
    });
    visitedCounts = {};
    contribCounts = {};
    runningTotal = 0;
  }

  // Build a sequence of events for step-by-step playback
  function generateQueryEvents(l, r, treeArr){
    const size = treeArr.size;
    const realN = treeArr.realLength || currentArray.length;
    if (!Number.isInteger(l) || !Number.isInteger(r) || l<0 || r<0 || l>r || r>=realN){
      return { error: `Query out of bounds — valid indices: 0 to ${Math.max(0, realN-1)}` };
    }

    let L = l + size;
    let R = r + size;
    const events = [];
    let res = 0;

    while (L <= R){
      // visit L
      events.push({ type:'visit', idx: L });
      // visit R (if different)
      if (R !== L) events.push({ type:'visit', idx: R });

      if (L % 2 === 1){
        events.push({ type:'add', idx: L, value: treeArr[L].value, range: [treeArr[L].start, treeArr[L].end] });
        res += treeArr[L].value;
        L++;
      }
      if (R % 2 === 0){
        events.push({ type:'add', idx: R, value: treeArr[R].value, range: [treeArr[R].start, treeArr[R].end] });
        res += treeArr[R].value;
        R--;
      }
      L = Math.floor(L / 2);
      R = Math.floor(R / 2);
    }

    return { events, result: res, l, r };
  }

  // Apply one event (forward)
  function applyEvent(ev){
    if (!ev) return;
    const el = document.getElementById('node-' + ev.idx);
    if (ev.type === 'visit'){
      visitedCounts[ev.idx] = (visitedCounts[ev.idx] || 0) + 1;
      if (el) el.classList.add('visited');
      // update step text
      stepsEl.innerHTML = `<div><strong>Step ${currentStep+1} / ${eventList.length}</strong></div>
        <small>Visited node index ${ev.idx} — range [${tree[ev.idx].start}, ${tree[ev.idx].end}], value ${tree[ev.idx].value}</small>
        <small style="margin-top:8px">Running total: <span style="font-weight:900">${runningTotal}</span></small>`;
    } else if (ev.type === 'add'){
      contribCounts[ev.idx] = (contribCounts[ev.idx] || 0) + 1;
      runningTotal += ev.value;
      if (el) el.classList.add('contrib');
      stepsEl.innerHTML = `<div><strong>Step ${currentStep+1} / ${eventList.length}</strong></div>
        <small>Added node index ${ev.idx} — range [${ev.range[0]}, ${ev.range[1]}] = ${ev.value}</small>
        <small style="margin-top:8px">Running total: <span style="font-weight:900">${runningTotal}</span></small>`;
    }
  }

  // Undo one event (backwards)
  function undoEvent(ev){
    if (!ev) return;
    const el = document.getElementById('node-' + ev.idx);
    if (ev.type === 'visit'){
      visitedCounts[ev.idx] = Math.max(0, (visitedCounts[ev.idx] || 0) - 1);
      if (visitedCounts[ev.idx] === 0 && el) el.classList.remove('visited');
      stepsEl.innerHTML = `<div><strong>Step ${currentStep+1} / ${eventList.length}</strong></div>
        <small>Undo visit node index ${ev.idx}</small>
        <small style="margin-top:8px">Running total: <span style="font-weight:900">${runningTotal}</span></small>`;
    } else if (ev.type === 'add'){
      contribCounts[ev.idx] = Math.max(0, (contribCounts[ev.idx] || 0) - 1);
      runningTotal -= ev.value;
      if (contribCounts[ev.idx] === 0 && el) el.classList.remove('contrib');
      stepsEl.innerHTML = `<div><strong>Step ${currentStep+1} / ${eventList.length}</strong></div>
        <small>Undo add node index ${ev.idx} — removed ${ev.value}</small>
        <small style="margin-top:8px">Running total: <span style="font-weight:900">${runningTotal}</span></small>`;
    }
  }

  // Move to next step
  function nextStepAction(){
    if (!eventList || eventList.length === 0) return;
    if (currentStep >= eventList.length - 1) return;
    currentStep++;
    applyEvent(eventList[currentStep]);
    updateButtons();
    if (currentStep === eventList.length - 1){
      // final summary
      setTimeout(() => {
        stepsEl.innerHTML = `<div><strong>Query [${eventList.metaL}, ${eventList.metaR}] — final result:</strong></div>
          <small>Nodes contributing: [${Object.keys(contribCounts).filter(k=>contribCounts[k]>0).join(', ')}]</small>
          <small style="margin-top:8px">Sum = <span style="font-size:1.1rem; font-weight:900">${runningTotal}</span></small>`;
      }, 120);
    }
  }

  // Move to previous step
  function prevStepAction(){
    if (!eventList || eventList.length === 0) return;
    if (currentStep < 0) return;
    undoEvent(eventList[currentStep]);
    currentStep--;
    updateButtons();
  }

  function updateButtons(){
    prevBtn.disabled = currentStep < 0;
    nextBtn.disabled = currentStep >= (eventList.length - 1);
  }

  function startPlay(){
    if (playInterval) return;
    playBtn.textContent = 'Pause';
    const delay = Number(speedRange.value);
    playInterval = setInterval(() => {
      if (currentStep >= eventList.length - 1){
        stopPlay();
        return;
      }
      nextStepAction();
    }, delay);
  }

  function stopPlay(){
    if (!playInterval) return;
    clearInterval(playInterval);
    playInterval = null;
    playBtn.textContent = 'Play';
  }

  // Reset everything (highlights and step list)
  function resetAll(){
    stopPlay();
    clearAllHighlights();
    eventList = [];
    currentStep = -1;
    stepsEl.innerHTML = `<div><strong>Steps / result:</strong></div><small>Build the tree and run a query to record steps.</small>`;
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    playBtn.disabled = true;
  }

  // wire UI
  buildBtn.addEventListener('click', () => {
    const arr = parseArrayInput(arrayInput.value);
    if (!arr.length){ alert('Enter at least one numeric value (comma separated).'); return; }
    currentArray = arr;
    renderArray(arr);
    tree = buildSegmentTree(arr);
    renderTreeDOM(tree);
    resetAll();
    ql.value = 0;
    qr.value = Math.max(0, arr.length - 1);
  });

  runQueryBtn.addEventListener('click', () => {
    if (!tree){ alert('Build tree first.'); return; }
    resetAll();
    const l = Number(ql.value);
    const r = Number(qr.value);
    const gen = generateQueryEvents(l, r, tree);
    if (gen.error){
      stepsEl.innerHTML = `<div><strong>Error:</strong></div><small style="color:#ffd6d6">${gen.error}</small>`;
      return;
    }
    eventList = gen.events;
    // store meta
    eventList.metaL = gen.l;
    eventList.metaR = gen.r;

    // enable controls
    prevBtn.disabled = true;
    nextBtn.disabled = false;
    playBtn.disabled = false;
    currentStep = -1;
    visitedCounts = {};
    contribCounts = {};
    runningTotal = 0;

    // show initial info
    stepsEl.innerHTML = `<div><strong>Recorded ${eventList.length} step(s) for query [${gen.l}, ${gen.r}]</strong></div><small>Use Next to step forward, Prev to step back, Play to autoplay.</small>`;

    // focus first step ready
  });

  nextBtn.addEventListener('click', () => { stopPlay(); nextStepAction(); });
  prevBtn.addEventListener('click', () => { stopPlay(); prevStepAction(); });
  playBtn.addEventListener('click', () => {
    if (!eventList || eventList.length === 0) return;
    if (playInterval) stopPlay(); else startPlay();
  });

  speedRange.addEventListener('input', () => {
    if (playInterval){
      stopPlay();
      startPlay();
    }
  });

  document.getElementById('tree-panel').addEventListener('scroll', drawAllConnectors);
  window.addEventListener('resize', () => requestAnimationFrame(drawAllConnectors));

  // reset
  const resetBtn = document.getElementById('array-display').closest('div').querySelector('button[aria-reset]');
  // build default
  buildBtn.click();

})();
</script>
</body>
</html>
